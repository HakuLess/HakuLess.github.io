
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>Freeline修改笔记 | HaKuLess</title>
<meta name="description" content="精神病人思路广，脑残儿童欢乐多">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://hakuless.github.io//favicon.ico?v=1562294380249">
<link rel="stylesheet" href="https://hakuless.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://hakuless.github.io/">
        <img class="avatar" src="https://hakuless.github.io//images/avatar.png?v=1562294380249" alt="" width="32px" height="32px">
      </a>
      <a href="https://hakuless.github.io/">
        <h1 class="site-title">HaKuLess</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            首页
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            归档
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            标签
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            关于
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">Freeline修改笔记</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2017-12-25</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://hakuless.github.io//tag/tech">
                    Tech
                    
                      ，
                    
                  </a>
                
                  <a href="https://hakuless.github.io//tag/android">
                    Android
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content">
            <h2 id="起因">起因</h2>
<p>美团点评合并后，许多业务线的客户端开发需要在 <strong>大众点评</strong> &amp; <strong>美团</strong>（甚至更多）的App上进行开发，而其中很可能有很多业务是重复的，如果通过copy代码不利于以后的修改，因此许多业务线使用提取子BU的公共业务库来解决该问题。</p>
<p>目前，因为海外团队需要跨地域（北京、上海）协作共同开发该复用库，且点评、美团的迭代周期也有差异，所以只要通过flavor打有一定差异的代码才能满足自己的迭代不会受到对方的影响。</p>
<p>而对我来说最蛋疼不过的就是Freeline（0.8.8）不支持子module有falvor，而看到freeline的issue和mr也有人提出相应的问题及代码，所以决定本地开搞一个兼容该情况的<strong>Freeline</strong>！😜</p>
<h2 id="工作流程">工作流程</h2>
<h3 id="不支持什么">不支持什么？</h3>
<p>首先，先让我们看下什么都不做的情况下用Freeline build会有什么问题，执行一下py freeline.py -d，发现编译不过会报错.. 截图如下：
<img src="https://ws4.sinaimg.cn/large/006tNc79gy1fmsuqhg299j30vi0d6js4.jpg" alt=""></p>
<p>详细的看下，会发现是许多资源（可以包括java代码、xml和图片等）找不到，追其原因是flavor是按文件夹打包。比如打dianping渠道，会打包dianping和main文件夹，而meituan则会打meituan和main文件夹，对于这种Freeline的现状就只会打main文件夹... 所以只要flavor文件夹里有必要的内容就build不起来了.. 😂</p>
<h3 id="如何修改">如何修改？</h3>
<p>万能的gayhub上有许多大神潜伏者，<a href="https://github.com/alibaba/freeline/pull/857">https://github.com/alibaba/freeline/pull/857</a>，这里就是其中解决的PR，具体详细的解决原因后面再说，现在先说下这个该如何使用。</p>
<p>目前（2017.12.25），freeline官方还没有合入这个PR，因此无法通过官方的gradle插件解决该问题，那么我们只好自己build自己的freeline插件了！主要分为以下几步，每步都会详细的介绍~</p>
<ol>
<li>fork freeline or 直接clone freeline</li>
<li>修改代码，增加flavor支持</li>
<li>使用gradlew install使插件build到本地库中</li>
<li>修改自己项目中引入freeline的插件</li>
<li>修改初始化后的python代码</li>
<li>愉快的使用freeline build</li>
</ol>
<h4 id="代码修改">代码修改</h4>
<ul>
<li>修改groovy代码，具体diff只有一行 <a href="https://github.com/alibaba/freeline/pull/857/files#diff-4">https://github.com/alibaba/freeline/pull/857/files#diff-4</a>，只需要把module的flavor和buildtype传入即可，其余的工作可以直接交给python脚本即可</li>
<li>而由于我们需要发布到本地的maven库，为防止与freeline官方混淆，可以修改版本号 or 包名，我采用的方案是把版本号改成0.8.9（截至目前还未发布）</li>
<li>修改版本号一共两部分，1是gradle.porperties中的，2是build.gradle发布中的，如下图所示：
<img src="https://ws4.sinaimg.cn/large/006tNc79gy1fmsvgkwshyj30x407iq37.jpg" alt="">
<img src="https://ws4.sinaimg.cn/large/006tNc79gy1fmsvh8m0dzj30x40auglw.jpg" alt=""></li>
</ul>
<h4 id="本地发布">本地发布</h4>
<p>修改好代码后，我们需要将gradle插件发布到本地，在freeline工程根目录执行./gradlew install，执行完成后你就会发现你的插件发布在本地maven的仓库中了。对于mac来说路径在~/.m2隐藏文件夹下，并且版本号是你发布的版本号！
<img src="https://ws1.sinaimg.cn/large/006tNc79gy1fmsvlu520uj30u806qmxf.jpg" alt=""></p>
<h4 id="修改项目">修改项目</h4>
<p>这回需要修改咱们自己的工程了~ 首先，如果你的build.gradle下的repositories如果没有mavenLocal请+一下，并且放在第一个，然后将你依赖中的freeline:gradle的版本改成你刚才build的版本（对我来说是0.8.9）</p>
<p>接下来，与正常直接引入freeline无差异，sync后执行./gradlew initFreeline -Pmirror，我这网不够好，用镜像能快不少... 执行完成后，会自动拉取官方freeline的python代码，你也可以修改gradle插件的下载路径，直接下载你将要修改的python，我是懒得发布... 就直接本地改吧，反正freeline更新频率还是很低的..</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fmsw1hkox5j31ju0r83zq.jpg" alt="">
在旧版本的项目信息中，modules只会包含name 和 path，而使用本地插件后，则会增加flavor和buildtype这两个属性，如下图所示：
<img src="https://ws1.sinaimg.cn/large/006tNc79gy1fmsw8aibobj31g20ogwfr.jpg" alt=""></p>
<p>之后还要修改主工程根目录下freeline文件夹中的<strong>gradle_tools.py</strong>，具体diff参考<a href="https://github.com/alibaba/freeline/pull/857/files#diff-9">https://github.com/alibaba/freeline/pull/857/files#diff-9</a>，将flavor加入打包的资源路径，下面就可以执行python freeline.py -d -f了！</p>
<p>注意：如果你要修改打包渠道，需要执行一次python freeline.py -f，强制重新写一遍projectInfo，否则默认会用原来的配置进行增量编译。</p>
<p>在之后，就可以愉快的使用增量编译了，在一些超大App动辄编译一下5~10min都只要20s以内就可以搞定！</p>
<h3 id="为什么这么修改">为什么这么修改？</h3>
<p>其实，了解过Freeline源码的同学大概能明白Freeline的核心内容是什么。纯从代码的角度来看可分为python执行部分与gradle插件部分（当然还有自行改写的appt、dx等工具）。</p>
<p>之前，之所以没支持子module的flavor，主要是因为module资源的路径地址没有增加flavor文件夹，所以通过简单的传参，从gradle插件层 -&gt; python脚本层把flavor传过来即可。</p>
<h2 id="总结">总结</h2>
<p>本次算是第一个对gradle插件的开发流程稍有了解，接下来打算从零开发一个插件。开发插件与java开发module的技术栈还是有不少差异的~ 开启新的技能点！（如果可以的话，真想全职去搞Freeline 😁）</p>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://hakuless.github.io//post/android-camera-cai-keng-xiang-jie">
              <h3 class="post-title">
                下一篇：Android Camera踩坑详解
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">精神病人思路广，脑残儿童欢乐多</div>
  <div class="social-container">
    
      
        <a href="https://github.com/HakuLess" target="_blank">
          <i class="fab fa-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
  </div>
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
