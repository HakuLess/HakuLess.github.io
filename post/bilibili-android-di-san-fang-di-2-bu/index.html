
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>BiliBili Android第三方——第2步 | HaKuLess</title>
<meta name="description" content="精神病人思路广，脑残儿童欢乐多">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://hakuless.github.io//favicon.ico?v=1557974507219">
<link rel="stylesheet" href="https://hakuless.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://hakuless.github.io/">
        <img class="avatar" src="https://hakuless.github.io//images/avatar.png?v=1557974507219" alt="" width="32px" height="32px">
      </a>
      <a href="https://hakuless.github.io/">
        <h1 class="site-title">HaKuLess</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            首页
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            归档
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            标签
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            关于
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">BiliBili Android第三方——第2步</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2016-03-23</span>
            
              <span>
                <i class="icon-pricetags-outline"></i>
                
                  <a href="https://hakuless.github.io//tag/tech">
                    Tech
                    
                      ，
                    
                  </a>
                
                  <a href="https://hakuless.github.io//tag/nR3LVeaXe">
                    Life
                    
                  </a>
                
              </span>
            
          </div>
          <div class="post-content">
            <h3 id="视频播放">视频播放</h3>
<p>bilibili的核心功能不用说，即播放视频 + 弹幕功能，本章主要讲述如何在Android中播放B站视频（争取下一章中加入弹幕功能）。首先，Android中播放视频使用Bilibili官方开源的ijkMediaPlayer，Android自带的MediaPlayer支持格式有限，无法满足Bilibili视频源的格式。ijkPlayer的github中展示了许多编译、修改的内容，对于仅需要使用的可以暂时不看。</p>
<h4 id="获取视频地址">获取视频地址</h4>
<p>视频主要分为2类，直播和点播，这两类的接口是不一样的。其中点播又有专辑、番剧等包含集数等概念的内容，需要播放不同内容。这里我们只讨论一个地址的那种，即单个视频。</p>
<ol>
<li>直播地址</li>
<li>点播地址</li>
</ol>
<p>直播地址URL如下，可以通过live/Index获取直播页的内容，其中最重要的内容为每一个直播Item的room_id，其他也有很多接口获取房间号内容，如直播详情、直播列表等，这里使用直播首页作为示例。</p>
<pre><code>http://live.bilibili.com/AppIndex/home?_device=android&amp;_hwid=51e96f5f2f54d5f9&amp;_ulv=10000&amp;access_key=563d6046f06289cbdcb472601ce5a761&amp;appkey=c1b107428d337928&amp;build=410000&amp;platform=android&amp;scale=xxhdpi&amp;sign=fbdcfe141853f7e2c84c4d401f6a8758
</code></pre>
<pre><code>{
    owner: {
        face: &quot;http://i0.hdslb.com/bfs/face/ac9785955b2d95391495869e7d64b8dc7d9499d4.jpg&quot;,
        mid: 867152,
        name: &quot;Tsubomixy&quot;
    },
    cover: {
        src: &quot;http://i0.hdslb.com/group1/M00/B6/AA/oYYBAFbmgraAF4DkAADqc2Inrws485.jpg&quot;,
        height: 180,
        width: 320
    },
    title: &quot;疯狂掉分少年&quot;,
    room_id: 81414,
    online: 157
}
</code></pre>
<p>每一个直播间的Item如上述Json，每一个视频直播都对应一个直播间Id，与Web端相同，通过调用接口获取视频直播地址。具体playurl接口获取直播视频地址如下，返回数据为xml格式，</p>
<pre><code>http://live.bilibili.com/api/playurl?player=1&amp;quality=0&amp;cid=room_id
</code></pre>
<p>房间号23058为B站官方音乐直播间，房间号稳定，可供大家测试。</p>
<p>将http://live.bilibili.com/api/playurl?player=1&amp;quality=0&amp;cid=23058粘到浏览器中即可，这种xml格式浏览器无法直接解析因此可能看不到内容，需要查看源代码，即可查看到如下图的内容：</p>
<p>![直播地址xml](https://github.com/HakuLess/ImageLib/blob/master/blog/live_xml.png?raw=true =744x209)</p>
<p>url为默认使用线路，b1、b2、b3指的是备用线路1、2、3。至此，我们获取到了B站直播的播放地址。接下来就可以使用ijkplayer使用该地址进行播放视频。</p>
<p>点播地址URL与直播地址相似，同样有cid的概念。首先需要通过其他接口获取视频直播地址的cid，然后通过如下接口获取点播视频的地址：</p>
<pre><code>String sign_this = string2MD5(&quot;appkey=&quot; + appkey + &quot;&amp;cid=&quot; + cid + secretkey);
String url = &quot;http://interface.bilibili.com/playurl?appkey=&quot; + appkey + &quot;&amp;cid=&quot; + cid + &quot;&amp;sign=&quot; + sign_this;
</code></pre>
<p>视频点播与直播不一样需要使用secretkey进行md5加密，这部分详细内容可以查看第0步的内容。这里使用cid为3885454为例，其获取地址URL为http://interface.bilibili.com/playurl?appkey=f3bb208b3d081dc8&amp;cid=3885454&amp;sign=3aa2879fb591b4e297ed3e69156c821e。</p>
<pre><code>&lt;video&gt;
    &lt;result&gt;suee&lt;/result&gt;
    &lt;timelength&gt;206000&lt;/timelength&gt;
    &lt;format&gt;
        &lt;![CDATA[ flv ]]&gt;
    &lt;/format&gt;
    &lt;accept_format&gt;
        &lt;![CDATA[ mp4,hdmp4,flv ]]&gt;
    &lt;/accept_format&gt;
    &lt;accept_quality&gt;
        &lt;![CDATA[ 3,2,1 ]]&gt;
    &lt;/accept_quality&gt;
    &lt;from&gt;
        &lt;![CDATA[ local ]]&gt;
    &lt;/from&gt;
    &lt;seek_param&gt;
        &lt;![CDATA[ start ]]&gt;
    &lt;/seek_param&gt;
    &lt;seek_type&gt;
        &lt;![CDATA[ offset ]]&gt;
    &lt;/seek_type&gt;
    &lt;src&gt;0&lt;/src&gt;
    &lt;durl&gt;
        &lt;order&gt;1&lt;/order&gt;
        &lt;length&gt;206000&lt;/length&gt;
        &lt;size&gt;39674116&lt;/size&gt;
        &lt;url&gt;
            &lt;![CDATA[
http://cn-zjhz5-dx.acgvideo.com/vg11/0/28/3885454-1.flv?expires=1458561300&amp;ssig=SalA4VKqDvz49duWpIJ1Tg&amp;oi=1961670062&amp;appkey=f3bb208b3d081dc8&amp;or=3026306826&amp;rate=0
]]&gt;
        &lt;/url&gt;
        &lt;backup_url&gt;
            &lt;url&gt;
                &lt;![CDATA[
http://cn-zjwz3-dx.acgvideo.com/vg16/7/18/3885454-1.flv?expires=1458561300&amp;ssig=OmgeF1kfdbUgTkGTBMO2xw&amp;oi=1961670062&amp;appkey=f3bb208b3d081dc8&amp;or=3026306826&amp;rate=0
]]&gt;
            &lt;/url&gt;
            &lt;url&gt;
                &lt;![CDATA[
http://cn-zjsx10-dx.acgvideo.com/vg2/f/a0/3885454-1.flv?expires=1458561300&amp;ssig=MTYHl-CUFarh8LpXnMXjEg&amp;oi=1961670062&amp;appkey=f3bb208b3d081dc8&amp;or=3026306826&amp;rate=0
]]&gt;
        &lt;/url&gt;
        &lt;/backup_url&gt;
    &lt;/durl&gt;
&lt;/video&gt;```

其中三个URL分别为默认线路、备用线路1和备用线路2。至此，获取单个视频点播的视频地址~ 下面就可以使用播放器进行视频播放了~！
 
##### 播放视频

播放视频的方式不止一种，这里只提供使用ijkplayer播放视频的方式，需要的同学可以看[ijkplayer github](https://github.com/Bilibili/ijkplayer)。对于我们只使用不修改的同学，可以直接在gradle中配置即可。

</code></pre>
<p>required
allprojects {
repositories {
jcenter()
}
}</p>
<p>dependencies {
# required, enough for most devices.
compile 'tv.danmaku.ijk.media:ijkplayer-java:0.4.5.1'
compile 'tv.danmaku.ijk.media:ijkplayer-armv7a:0.4.5.1'</p>
<pre><code># Other ABIs: optional
compile 'tv.danmaku.ijk.media:ijkplayer-armv5:0.4.5.1'
compile 'tv.danmaku.ijk.media:ijkplayer-arm64:0.4.5.1'
compile 'tv.danmaku.ijk.media:ijkplayer-x86:0.4.5.1'

# ExoPlayer as IMediaPlayer: optional, experimental
compile 'tv.danmaku.ijk.media:ijkplayer-exo:0.4.5.1'
</code></pre>
<p>}</p>
<pre><code>对于大部分情况只需要配置required项即可，之后就可以在项目中直接使用ijkMediaPlayer，使用方式与普通的MediaPlayer相似，具体代码如下：

</code></pre>
<p>private void playVideo(String uri) {
try {
ijkMediaPlayer.setDataSource(this, Uri.parse(uri));
ijkMediaPlayer.setDisplay(holder);
holder.addCallback(new SurfaceHolder.Callback() {
@Override
public void surfaceCreated(SurfaceHolder holder) {</p>
<pre><code>            }

            @Override
            public void surfaceChanged(SurfaceHolder holder, int format, int width, int height) {
                ijkMediaPlayer.setDisplay(holder);
            }

            @Override
            public void surfaceDestroyed(SurfaceHolder holder) {

            }
        });
        ijkMediaPlayer.prepareAsync();
        ijkMediaPlayer.start();
    } catch (IOException e) {
        e.printStackTrace();
    }
}
</code></pre>
<pre><code>
完整项目代码可以在[我的github](https://github.com/HakuLess)中查看。项目截图与bilibili官方对比图如下：
 ![直播首页截图](https://github.com/HakuLess/ImageLib/blob/master/blog/compare_live_index.png?raw=true =578x499)
 ![直播页面_官方](https://raw.githubusercontent.com/HakuLess/ImageLib/master/blog/compare_live_play_bili.jpeg?raw=true =285x577)
 ![直播页面_自定义](https://github.com/HakuLess/ImageLib/blob/master/blog/compare_live_play_hbili.jpeg?raw=true?raw=true =285x577)
 
 有待开发的功能还有很多，如弹幕、评论、视频下载等，大家敬请期待~
 I
##### ThanksTo

* [bilibili视频解析](http://www.iippcc.com/bilibili/)
* [爱bilibili](http://www.ibilibili.com/)
* [B站视频地址获取](https://www.blackglory.me/bilibili-video-source-get/)
* [B站API](http://www.fuckbilibili.com/biliapi.html)
* [哔哩哔哩JJ](http://www.bilibilijj.com/)</code></pre>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://hakuless.github.io//post/bilibili-android-di-san-fang-di-1-bu">
              <h3 class="post-title">
                下一篇：BiliBili Android第三方——第1步
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan">精神病人思路广，脑残儿童欢乐多</div>
  <div class="social-container">
    
      
        <a href="https://github.com/HakuLess" target="_blank">
          <i class="fab fa-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
  </div>
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
